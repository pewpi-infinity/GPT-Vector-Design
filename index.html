<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rogers AI Console — Diagnostic</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, Arial; background:#0d1117; color:#c9d1d9; margin:0; padding:20px; display:flex; justify-content:center; }
    .container { width:100%; max-width:900px; background:#161b22; border-radius:12px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.6); }
    #chat-window { height:48vh; overflow:auto; background:#0d1117; border-radius:8px; padding:10px; border:1px solid #30363d; }
    .message { margin-bottom:8px; padding:8px 12px; border-radius:8px; max-width:80%; word-wrap:break-word; }
    .user-message{ background:#21262d; margin-left:auto; border:1px solid #30363d; }
    .rogers-message{ background:#0d1117; border:1px solid #30363d; }
    .status-indicator{ padding:6px 12px; border-radius:9999px; font-weight:700; font-size:.875rem; text-align:center; }
    .status-offline{ background:#da3633; color:#fff; }
    .status-online{ background:#3fb950; color:#000; }
    .diag { margin-top:14px; background:#0b0f14; padding:12px; border-radius:8px; border:1px solid #23303a; color:#c7d1d9; font-family:monospace; font-size:13px; white-space:pre-wrap; max-height:220px; overflow:auto; }
    .row { display:flex; gap:8px; align-items:center; margin-top:10px; }
    .btn { background:#2563eb; color:#fff; padding:8px 12px; border-radius:8px; border:0; cursor:pointer; }
    .small { font-size:12px; color:#9aa6b2; }
    label { display:flex; gap:8px; align-items:center; cursor:pointer; }
  </style>
</head>
<body>
  <div class="container" id="app">
    <div class="flex justify-between items-center border-b pb-3 border-[#30363d]">
      <h1 class="text-2xl font-bold text-blue-400">Rogers AI Console — Diagnostic</h1>
      <div id="status" class="status-indicator status-offline">OFFLINE (Connecting...)</div>
    </div>

    <div id="chat-window"></div>

    <div class="row">
      <input id="user-input" type="text" placeholder="Type your message..." disabled
             class="flex-grow p-3 bg-[#0d1117] border border-[#30363d] rounded-lg text-sm disabled:opacity-50" />
      <button id="send-button" class="btn" disabled>Send</button>
      <button id="refresh" class="btn">Check Status</button>
      <label class="small" title="Force enable controls for testing">
        <input id="force-enable" type="checkbox"/> Force enable
      </label>
    </div>

    <div class="small" style="margin-top:8px;">
      Server URL: <code id="server-url">http://100.118.99.166:5000</code>
    </div>

    <h3 style="margin-top:12px; margin-bottom:6px; color:#cfe8c3">Diagnostics</h3>
    <div id="diag" class="diag">
      Last status fetch: (none)
    </div>
  </div>

  <script>
  (function(){
    const SERVER = "http://100.118.99.166:5000";
    document.getElementById('server-url').textContent = SERVER;

    const statusEl = document.getElementById('status');
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const refreshBtn = document.getElementById('refresh');
    const diag = document.getElementById('diag');
    const forceToggle = document.getElementById('force-enable');

    let isOnline = false;

    function logDiag(text) {
      const now = new Date().toISOString();
      diag.textContent = `${now} — ${text}\n\n` + diag.textContent;
    }

    function setStatus(online, message) {
      isOnline = !!online;
      statusEl.textContent = message || (isOnline ? "ONLINE" : "OFFLINE");
      statusEl.className = 'status-indicator ' + (isOnline ? 'status-online' : 'status-offline');
      const forced = forceToggle.checked;
      const effectiveOnline = forced ? true : isOnline;
      userInput.disabled = !effectiveOnline;
      sendButton.disabled = !effectiveOnline;
      if (effectiveOnline) userInput.focus();
    }

    function addMessage(role, text) {
      const d = document.createElement('div');
      d.classList.add('message', role === 'user' ? 'user-message' : 'rogers-message');
      d.textContent = String(text);
      if (role === 'user') d.style.textAlign = 'right';
      chatWindow.appendChild(d);
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function checkStatus() {
      setStatus(false, 'Connecting...');
      logDiag('Starting status fetch to ' + SERVER + '/api/status');

      // Mixed-content detection
      if (location.protocol === 'https:' && SERVER.startsWith('http:')) {
        const msg = 'MIXED-CONTENT WARNING: page loaded over HTTPS but server is HTTP. Browser will block the request.';
        logDiag(msg);
        setStatus(false, 'OFFLINE (Mixed Content)');
        return;
      }

      try {
        const resp = await fetch(SERVER + '/api/status', { method:'GET', cache:'no-store', mode:'cors' });
        const text = await resp.text();
        logDiag(`Status fetch HTTP ${resp.status}\nResponse body:\n${text}`);
        let parsed = null;
        try { parsed = JSON.parse(text); } catch(e) { /* keep raw text */ }

        if (resp.ok && parsed && parsed.status === 'ready') {
          setStatus(true, 'ONLINE');
          addMessage('rogers', 'System: Rogers AI Console is online and ready.');
        } else {
          // If HTTP 200 but status not ready, show payload
          setStatus(false, `OFFLINE (Bad Status${resp.status?':'+resp.status:''})`);
        }
      } catch (err) {
        // network / CORS / blocked fetch errors
        logDiag('Fetch error: ' + String(err));
        console.error(err);
        setStatus(false, 'OFFLINE (Network Error)');
      }
    }

    async function sendMessage() {
      const q = (userInput.value || '').trim();
      if (!q) return;
      if (!isOnline && !forceToggle.checked) {
        addMessage('rogers', 'Cannot send: server offline.');
        return;
      }
      addMessage('user', q);
      userInput.value = '';
      setStatus(false, 'Sending...');
      try {
        const resp = await fetch(SERVER + '/api/bot/execute', {
          method:'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ query: q }),
          cache:'no-store',
          mode:'cors'
        });
        const text = await resp.text();
        logDiag(`POST /api/bot/execute HTTP ${resp.status}\nBody:\n${text}`);
        let parsed = null;
        try { parsed = JSON.parse(text); } catch(e) { parsed = null; }

        if (resp.ok && parsed && parsed.ok && parsed.response) {
          addMessage('rogers', parsed.response);
        } else {
          addMessage('rogers', 'Error: ' + (parsed && parsed.message ? parsed.message : text));
        }
      } catch (err) {
        logDiag('Send error: ' + String(err));
        console.error(err);
        addMessage('rogers', 'Critical Network Failure: Could not execute bot.');
      } finally {
        // re-check status after send
        await checkStatus();
      }
    }

    // Bindings
    refreshBtn.addEventListener('click', () => checkStatus());
    sendButton.addEventListener('click', () => sendMessage());
    userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });
    forceToggle.addEventListener('change', () => {
      const forced = forceToggle.checked;
      if (forced) logDiag('Force enable toggled ON by user; UI enabled for testing.');
      else logDiag('Force enable toggled OFF; UI will reflect real status.');
      setStatus(isOnline, statusEl.textContent);
    });

    // Global error handlers to show diagnostics in-page
    window.addEventListener('error', (ev) => {
      logDiag('Global error: ' + (ev && ev.error && ev.error.stack ? ev.error.stack : ev.message));
    });
    window.addEventListener('unhandledrejection', (ev) => {
      logDiag('Unhandled Promise Rejection: ' + (ev && ev.reason ? (ev.reason.stack || String(ev.reason)) : String(ev)));
    });

    // Start initial check (and poll every 5s)
    (function init(){
      setTimeout(() => {
        checkStatus();
        setInterval(() => checkStatus(), 5000);
      }, 30);
    })();

    // Expose for manual debug
    window.__rogers_diag = { checkStatus, sendMessage, logDiag };

  })();
  </script>
</body>
</html>
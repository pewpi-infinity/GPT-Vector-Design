<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Rogers — Test UI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:18px;max-width:900px}
    h1{font-size:1.2rem;margin-bottom:6px}
    .row{display:flex;gap:8px;align-items:center;margin-top:8px}
    input[type=text], input[type=url], select{padding:8px;font-size:1rem;flex:1}
    button{padding:8px 12px}
    #chat{border:1px solid #ccc;padding:12px;min-height:140px;white-space:pre-wrap;background:#fafafa}
    .msg-user{color:#004; font-weight:600}
    .msg-bot{color:#060}
    label{font-size:0.9rem;color:#333}
    .small{font-size:0.85rem;color:#666;margin-top:6px}
  </style>
</head>
<body>
  <h1>Rogers — Test UI</h1>
  <div class="small">This page sends queries to the server helper (default port 8765). If the server is running rogers_http.py, you can type questions and ask Rogers to fetch GitHub files using the built-in "fetch github" command.</div>

  <div style="margin-top:12px">
    <div id="chat" aria-live="polite"></div>

    <div class="row" style="margin-top:10px">
      <input id="query" type="text" placeholder="Type your question to Rogers (e.g. 'hello' or 'search openai')" />
      <button id="send">Send</button>
      <button id="clear">Clear</button>
    </div>

    <div style="margin-top:12px">
      <label>Fetch a file from GitHub via the server-side logic (no client token needed)</label>
      <div class="row">
        <input id="gh_owner" type="text" placeholder="owner (example: timrogers)" />
        <input id="gh_repo" type="text" placeholder="repo (example: airports)" />
        <input id="gh_path" type="text" placeholder="path (example: README.md or src/file.py)" />
        <input id="gh_ref" type="text" placeholder="ref (branch or commit) (optional)" />
        <button id="gh_fetch">Fetch</button>
      </div>
      <div class="small">This form builds a query like: <code>fetch github &lt;owner&gt; &lt;repo&gt; &lt;path&gt; [&lt;ref&gt;]</code> and sends it to the server. The server (rogers_logic) will use any configured GITHUB_PAT if available to call GitHub's API.</div>
    </div>

    <div style="margin-top:12px">
      <label>Server helper URL (change if helper runs on different host/port)</label>
      <div class="row">
        <input id="server_url" type="url" placeholder="http://localhost:8765" value="" />
        <button id="set_url">Apply</button>
      </div>
      <div class="small">If left empty the page will use the current host with port 8765.</div>
    </div>

    <div style="margin-top:14px">
      <button id="helpme">Help: example queries</button>
    </div>
  </div>

  <script>
    (function(){
      const chat = document.getElementById('chat');
      const qel = document.getElementById('query');
      const send = document.getElementById('send');
      const clear = document.getElementById('clear');
      const gh_fetch = document.getElementById('gh_fetch');
      const ownerEl = document.getElementById('gh_owner');
      const repoEl = document.getElementById('gh_repo');
      const pathEl = document.getElementById('gh_path');
      const refEl = document.getElementById('gh_ref');
      const serverUrlEl = document.getElementById('server_url');

      function baseUrl(){
        const v = serverUrlEl.value && serverUrlEl.value.trim();
        if(v) return v.replace(/\/+$/,'');
        const host = window.location.hostname || 'localhost';
        return 'http://' + host + ':8765';
      }

      function appendUser(text){
        chat.innerHTML += '<div><span class="msg-user">You:</span> '+escapeHtml(text)+'</div>';
        chat.scrollTop = chat.scrollHeight;
      }
      function appendBot(text){
        chat.innerHTML += '<div><span class="msg-bot">Rogers:</span> '+escapeHtml(text)+'</div>';
        chat.scrollTop = chat.scrollHeight;
      }
      function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

      async function sendQuery(q){
        appendUser(q);
        appendBot('...waiting...');
        try{
          const res = await fetch(baseUrl() + '/query', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({query: q})
          });
          const j = await res.json();
          const nodes = chat.childNodes;
          if(nodes.length) nodes[nodes.length-1].remove();
          if(j && j.response !== undefined){
            appendBot(j.response);
          } else {
            appendBot(JSON.stringify(j, null, 2));
          }
        } catch(err){
          const nodes = chat.childNodes;
          if(nodes.length) nodes[nodes.length-1].remove();
          appendBot('Network error: ' + err.toString() + '. Make sure rogers_http.py is running on ' + baseUrl());
        }
      }

      send.addEventListener('click', () => {
        const q = qel.value.trim();
        if(!q) return alert('Type a question first');
        sendQuery(q);
      });

      clear.addEventListener('click', () => { qel.value=''; chat.textContent=''; });

      qel.addEventListener('keydown', (ev) => {
        if(ev.key === 'Enter'){ ev.preventDefault(); send.click(); }
      });

      gh_fetch.addEventListener('click', () => {
        const owner = ownerEl.value.trim();
        const repo = repoEl.value.trim();
        const path = pathEl.value.trim();
        const ref = refEl.value.trim();
        if(!owner || !repo || !path) return alert('owner, repo and path are required');
        const q = ['fetch','github', owner, repo, path].concat(ref ? [ref] : []).join(' ');
        qel.value = q;
        send.click();
      });

      setUrl.addEventListener('click', () => {
        alert('Server helper set to: ' + baseUrl());
      });

      helpBtn.addEventListener('click', () => {
        const examples = [
          "hello",
          "search who invented the telephone",
          "summarize https://example.com",
          "fetch github owner repo path/to/file.py"
        ];
        alert('Example queries:\\n' + examples.join('\\n'));
      });

      (async function ping(){
        try{
          const r = await fetch(baseUrl() + '/query?q=hello', {cache:'no-store'});
          const j = await r.json();
          appendBot('Helper reachable: ' + (j && j.response ? j.response : JSON.stringify(j)));
        } catch(e){
          appendBot('Helper not reachable at ' + baseUrl() + ' — start rogers_http.py on the server and retry.');
        }
      })();
    })();
  </script>
</body>
</html>
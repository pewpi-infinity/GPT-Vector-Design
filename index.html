<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PewPi — Buttons + Color Words + Admin</title>
  <style>
    :root{
      --bg:#071722; --card:#08242f; --muted:#9bb7c2; --accent:#16b07a; --panel:#041016;
      --purple:#b695ff; --green:#75e39a; --red:#ff8b8b; --blue:#8fd1ff; --orange:#ffb06b; --yellow:#fff28f;
    }
// Delegated nav + portal fallback patch — paste into console or add before </body>
(function(){
  // safe guard to not attach twice
  if(window.__pewpi_delegation_attached) return;
  window.__pewpi_delegation_attached = true;

  // debug helper (prints to in-page debug area if present)
  function dbg(m){
    try{
      var d = document.getElementById('debug_out') || document.getElementById('pewpi_debug_out');
      var ts = new Date().toISOString().split('T')[1].slice(0,8);
      if(d) d.textContent = (d.textContent && d.textContent !== '{ no debug }' ? d.textContent + '\n' : '') + '['+ts+'] ' + m;
      console.log('[pewpi_delegate] ' + m);
    }catch(e){ console.log('[pewpi_delegate] ' + m); }
  }

  // delegated click handler for nav buttons and any element with data-view
  document.addEventListener('click', function(ev){
    try{
      var btn = ev.target.closest && ev.target.closest('[data-view], .nav-btn, .btn[data-view]');
      if(btn){
        ev.preventDefault();
        var view = btn.getAttribute('data-view') || btn.dataset && btn.dataset.view;
        if(!view && btn.classList.contains('nav-btn')) view = btn.textContent.trim().toLowerCase();
        if(view){
          // show/hide views
          document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
          var el = document.getElementById('view_' + view);
          if(el) el.style.display = 'block';
          // set active class
          document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
          if(btn.classList && btn.classList.add) btn.classList.add('active');
          dbg('Delegated nav -> ' + view);
          return;
        }
      }
      // portal send fallback (if send button clicked)
      var sendBtn = ev.target.closest && ev.target.closest('#portal_send, .action#portal_send, button#send');
      if(sendBtn){
        ev.preventDefault();
        var qEl = document.getElementById('portal_query') || document.getElementById('query');
        var cEl = document.getElementById('portal_console') || document.getElementById('console');
        var q = qEl ? (qEl.value || '').trim() : '';
        if(!q){ dbg('Delegated send: empty query'); return; }
        dbg('Delegated send: ' + q);
        // use rogersRespond if available, otherwise echo
        (async function(){
          try{
            if(typeof rogersRespond === 'function'){
              var r = await rogersRespond(q);
              if(cEl){ cEl.textContent += '\nYou: ' + q + '\nRogers: ' + r; cEl.scrollTop = cEl.scrollHeight; }
              else alert('Rogers: ' + r);
            } else {
              if(cEl){ cEl.textContent += '\nYou: ' + q + '\nRogers: (no handler)'; cEl.scrollTop = cEl.scrollHeight; }
              else alert('Rogers: (no handler)');
            }
          }catch(err){
            dbg('Delegated send error: ' + (err && err.message ? err.message : err));
            alert('Send error: ' + (err && err.message ? err.message : err));
          }
        })();
        return;
      }
    }catch(ex){
      dbg('Delegation outer error: ' + (ex && ex.message ? ex.message : ex));
    }
  }, false);

  // also add touchstart to improve mobile responsiveness
  document.addEventListener('touchstart', function(ev){
    try{
      var btn = ev.target.closest && ev.target.closest('[data-view], .nav-btn, .btn[data-view]');
      if(btn){
        ev.preventDefault();
        btn.click();
      }
    }catch(e){ /* ignore */ }
  }, { passive:false });

  // re-enable pointer-events and remove disabled flags globally (non-destructive)
  document.querySelectorAll('button, .nav-btn, input[type="button"], input[type="submit"]').forEach(function(b){
    try{ b.disabled = false; b.style.pointerEvents = 'auto'; b.style.opacity = ''; }catch(e){}
  });

  dbg('Delegated handlers installed.');
})();
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:#e9fbff}
    header{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.03)}
    h1{margin:0;font-size:1.0rem}
    .topbar{display:flex;gap:8px;align-items:center}
    .nav-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
    .nav-btn.active{background:var(--accent);color:#00221a;border-color:transparent}
    .wrap{display:flex;gap:16px;padding:12px;box-sizing:border-box;height:calc(100vh - 56px)}
    .left{flex:1;overflow:auto}
    .right{width:420px;min-width:300px;overflow:auto}
    .card{background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:12px}
    input,textarea,select,button{font:inherit}
    input,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#03141a;color:#e9fbff}
    textarea{min-height:100px;resize:vertical;font-family:monospace}
    .row{display:flex;gap:8px;margin-top:8px}
    .console{background:var(--panel);padding:10px;border-radius:8px;min-height:120px;white-space:pre-wrap;overflow:auto;color:#cfeee6}
    label{font-size:0.9rem;color:var(--muted);display:block;margin-top:8px}
    .tiny{font-size:0.85rem;color:var(--muted)}
    .words{line-height:1.6;font-size:1.05rem}
    .word{cursor:pointer;padding:2px 4px;border-radius:4px;text-decoration:none}
    .word.purple{background:rgba(181,149,255,0.08);color:var(--purple)}
    .word.green{background:rgba(117,227,154,0.06);color:var(--green)}
    .word.red{background:rgba(255,139,139,0.06);color:var(--red)}
    .word.blue{background:rgba(143,209,255,0.06);color:var(--blue)}
    .word.orange{background:rgba(255,176,107,0.06);color:var(--orange)}
    .word.yellow{background:rgba(255,242,143,0.06);color:var(--yellow);color:#222}
    .meta{font-size:0.85rem;color:var(--muted);margin-top:6px}
    .btn-primary{background:var(--accent);border:none;padding:8px 10px;border-radius:8px;color:#00221a;cursor:pointer}
    .btn-secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px;border-radius:8px;color:var(--muted);cursor:pointer}
    @media(max-width:900px){ .wrap{flex-direction:column} .right{width:100%;min-width:0} }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:12px">
      <h1>PewPi</h1>
      <div class="tiny">Unified Portal</div>
    </div>

    <div style="flex:1"></div>

    <div class="topbar" role="navigation" aria-label="Main navigation">
      <button class="nav-btn active" data-view="portal" id="nav_portal">Portal</button>
      <button class="nav-btn" data-view="admin" id="nav_admin">Admin</button>
      <button class="nav-btn" data-view="bots" id="nav_bots">Bots</button>
      <button class="nav-btn" data-view="logs" id="nav_logs">Logs</button>
      <button class="nav-btn" data-view="terminal" id="nav_terminal">Terminal</button>
    </div>
  </header>

  <div class="wrap">
    <div class="left">
      <!-- PORTAL -->
      <div class="card view" id="view_portal">
        <label><strong>Main Portal</strong></label>
        <div class="tiny">Click any colored word in the sentence below to act on it. Yellow words start the App Builder flow.</div>

        <div style="margin-top:10px" class="card">
          <label>Interactive Sentences</label>
          <div class="words" id="words_area">
            <!-- Example sentence: words wrapped and status set via data-status -->
            <span class="word purple" data-status="purple" data-key="purple">Purple</span> are already working with you.
            <span class="word green" data-status="green" data-key="green">Green</span> are ready.
            <span class="word red" data-status="red" data-key="red">Red</span> have errors.
            <span class="word blue" data-status="blue" data-key="blue">Blue</span> are awaiting info.
            <span class="word orange" data-status="orange" data-key="orange">Orange</span> are risky.
            <span class="word yellow" data-status="yellow" data-key="maps">Maps</span> are producing and making money.
            Click a colored word to interact.
          </div>
        </div>

        <div class="card">
          <label>Portal Chat</label>
          <div id="portal_console" class="console">Rogers: ready.</div>
          <div class="row" style="margin-top:8px">
            <input id="portal_query" placeholder='Type "fetch github owner repo path" or "hello"' />
            <button class="btn-primary" id="portal_send">Send</button>
          </div>
        </div>
      </div>

      <!-- BOTS -->
      <div class="card view" id="view_bots" style="display:none">
        <label><strong>Bot Farm (manual)</strong></label>
        <div class="tiny">Create small browser bots (manual approval for spawns).</div>
        <div class="row">
          <input id="bot_name" placeholder="bot name" />
          <select id="bot_type"><option value="echo">echo</option><option value="transform">transform</option><option value="fetch_github">fetch_github</option></select>
          <button class="btn-primary" id="create_bot">Create</button>
        </div>
        <div id="bots_list" style="margin-top:12px"></div>
      </div>

      <!-- LOGS -->
      <div class="card view" id="view_logs" style="display:none">
        <label><strong>Logs & Activity</strong></label>
        <div id="log_view" class="console">{ no events }</div>
        <div class="row" style="margin-top:8px">
          <input id="log_pass" type="password" placeholder="Encryption passphrase (not saved)" />
          <button class="btn-primary" id="encrypt_copy">Encrypt & Copy</button>
          <button class="btn-secondary" id="encrypt_commit">Encrypt & Commit (needs PAT)</button>
        </div>
        <pre id="last_ct" style="margin-top:8px;background:#021418;padding:8px;border-radius:6px;color:#cfeee6;max-height:160px;overflow:auto">{ none }</pre>
      </div>

      <!-- TERMINAL -->
      <div class="card view" id="view_terminal" style="display:none">
        <label><strong>Terminal / Commits</strong></label>
        <div class="tiny">Use this to commit encrypted blobs. Load PAT in Admin first.</div>
        <label>Owner / Repo</label>
        <div class="row"><input id="commit_owner" placeholder="owner" /><input id="commit_repo" placeholder="repo" /></div>
        <label>Branch / Path</label>
        <div class="row"><input id="commit_branch" placeholder="branch" value="main" /><input id="commit_path" placeholder="path (eg. logs.json)" /></div>
        <label>Message</label>
        <input id="commit_msg" placeholder="Commit message" value="Add encrypted log" />
        <label>Content (paste ciphertext JSON)</label>
        <textarea id="commit_content"></textarea>
        <div class="row" style="margin-top:8px">
          <button class="btn-primary" id="do_commit">Commit</button>
          <button class="btn-secondary" id="check_file">Check Exists</button>
        </div>
        <pre id="terminal_out" class="console" style="margin-top:8px">{ terminal }</pre>
      </div>
    </div>

    <div class="right">
      <div class="card view" id="view_admin" style="display:none">
        <label><strong>Admin / Unlock</strong></label>
        <div class="tiny">Paste ciphertext or enter your passphrase. "Put it here" field accepts the passphrase.</div>
        <label>Put it here</label>
        <div class="row">
          <input id="admin_pass" type="password" placeholder="Put it here" />
          <button class="btn-primary" id="admin_unlock">Unlock</button>
        </div>

        <label style="margin-top:8px">Ciphertext JSON (optional)</label>
        <textarea id="admin_blob" placeholder='Paste ciphertext JSON here if not embedded'></textarea>
        <div class="row" style="margin-top:8px">
          <input id="admin_rawurl" placeholder="raw.githubusercontent.com raw URL (optional)" />
          <button class="btn-secondary" id="fetch_blob">Fetch</button>
          <button class="btn-secondary" id="paste_clip">Paste clipboard</button>
        </div>

        <label style="margin-top:8px">In-memory PAT (for commits)</label>
        <div class="row">
          <input id="admin_pat" type="password" placeholder="Paste PAT here (memory only)" />
          <button class="btn-secondary" id="load_pat">Load</button>
          <button class="btn-secondary" id="clear_pat">Clear</button>
        </div>

        <div id="admin_status" class="tiny" style="margin-top:8px">No session</div>

        <label style="margin-top:8px">Decrypted preview</label>
        <pre id="admin_plain" style="max-height:160px;overflow:auto">{ none }</pre>
        <div class="row" style="margin-top:8px">
          <button class="btn-primary" id="load_token_from_plain">Load github_token into session</button>
          <button class="btn-secondary" id="re_encrypt">Re-encrypt (change passphrase)</button>
        </div>
      </div>

      <div class="card">
        <label><strong>Word Info</strong></label>
        <div id="word_info" class="tiny">Click a colored word to see info and actions.</div>
        <div style="margin-top:8px">
          <button class="btn-secondary" id="clear_log">Clear Session Log</button>
        </div>
      </div>

      <div class="card">
        <label><strong>Debug</strong></label>
        <div id="debug_out" class="console">{ no debug }</div>
      </div>
    </div>
  </div>

<script>
/* Lightweight single-file app:
   - Visible nav buttons (no hamburger)
   - Interactive color-coded words with click actions
   - Admin decrypt + load token to sessionStorage
   - Portal chat + simple rogersRespond
   - Basic bot farm + logs
   Mobile touch-friendly, defensive handlers and visible debug output.
*/

/* ---------- Utilities ---------- */
function $(id){ return document.getElementById(id); }
function logDebug(msg){
  const el = $('debug_out');
  const ts = new Date().toISOString().split('T')[1].slice(0,8);
  el.textContent = (el.textContent && el.textContent !== '{ no debug }' ? el.textContent + '\n' : '') + `[${ts}] ${msg}`;
  el.scrollTop = el.scrollHeight;
}
function appendLog(entry){
  SESSION_LOG.push({ ts: new Date().toISOString(), entry });
  $('log_view').textContent = JSON.stringify(SESSION_LOG, null, 2);
}

/* ---------- Simple WebCrypto helpers (PBKDF2 250k + AES-GCM) ---------- */
const ITER = 250000;
function u8FromB64(s){ const bin = atob(s); const u = new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) u[i]=bin.charCodeAt(i); return u; }
function u8ToB64(u8){ let s=''; for(let i=0;i<u8.length;i++) s+=String.fromCharCode(u8[i]); return btoa(s); }

async function deriveKey(pass, saltU8, usages=['encrypt','decrypt']){
  const enc = new TextEncoder();
  const base = await crypto.subtle.importKey('raw', enc.encode(pass), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey({ name:'PBKDF2', salt: saltU8, iterations: ITER, hash: 'SHA-256' }, base, { name:'AES-GCM', length:256 }, false, usages);
}

async function decryptBlob(blob, pass){
  if(!blob || !blob.ct) throw new Error('Invalid ciphertext blob');
  const salt = u8FromB64(blob.salt), iv = u8FromB64(blob.iv), ct = u8FromB64(blob.ct);
  const key = await deriveKey(pass, salt, ['decrypt']);
  const pt = await crypto.subtle.decrypt({ name:'AES-GCM', iv }, key, ct.buffer);
  return JSON.parse(new TextDecoder().decode(pt));
}

async function encryptJSON(obj, pass){
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(pass, salt, ['encrypt']);
  const ct = await crypto.subtle.encrypt({ name:'AES-GCM', iv }, key, new TextEncoder().encode(JSON.stringify(obj)));
  return { v:1, salt: u8ToB64(salt), iv: u8ToB64(iv), ct: u8ToB64(new Uint8Array(ct)), created_at: new Date().toISOString() };
}

/* ---------- Session and token management ---------- */
let SESSION_LOG = [];
let INMEM_TOKEN = null;
function setToken(t){
  INMEM_TOKEN = t;
  try { sessionStorage.setItem('gh.token', t); } catch(e){}
  // Broadcast to other tabs (best-effort)
  try{ const ch = new BroadcastChannel('pewpi-token'); ch.postMessage({ token: t }); ch.close(); }catch(e){}
  $('admin_status').textContent = 'Token loaded in session';
  logDebug('Token set in sessionStorage');
}
function clearToken(){
  INMEM_TOKEN = null;
  try { sessionStorage.removeItem('gh.token'); } catch(e){}
  $('admin_status').textContent = 'Token cleared';
  logDebug('Token cleared');
}
function getToken(){ return sessionStorage.getItem('gh.token') || INMEM_TOKEN || null; }

/* ---------- Navigation (visible buttons) ---------- */
function showView(name){
  document.querySelectorAll('.view').forEach(v=>v.style.display='none');
  const el = $('view_' + name);
  if(el) el.style.display = 'block';
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  const btn = document.querySelector('.nav-btn[data-view="'+name+'"]');
  if(btn) btn.classList.add('active');
}
document.querySelectorAll('.nav-btn').forEach(btn=>{
  // attach click and touch handlers
  btn.addEventListener('click', ()=> showView(btn.dataset.view));
  btn.addEventListener('touchstart', (ev)=>{ ev.preventDefault(); showView(btn.dataset.view); }, { passive:false });
});

/* ---------- Interactive words system ---------- */
const WORD_ACTIONS = {
  purple: { label:'Already working', info:'Purple items are integrated and functional.' },
  green: { label:'Ready', info:'Green items are ready to use.' },
  red: { label:'Error', info:'Red items indicate errors. Inspect logs.' },
  blue: { label:'Awaiting', info:'Blue items need extra info.' },
  orange: { label:'Risky', info:'Orange items are risky; proceed with caution.' },
  yellow: { label:'App Builder', info:'Yellow items can start the App Builder flow.' }
};

function onWordClick(ev){
  const el = ev.currentTarget;
  const status = el.dataset.status;
  const key = el.dataset.key || el.textContent.trim();
  const info = WORD_ACTIONS[status] || { label:status, info:'' };
  $('word_info').innerHTML = `<strong style="color:inherit">${key}</strong><div class="meta">${info.label}</div><div class="tiny" style="margin-top:6px">${info.info}</div>`;
  appendLog(`Word clicked: ${key} (${status})`);
  if(status === 'yellow'){
    // Start App Builder flow (simple prompt-based)
    setTimeout(()=> startAppBuilder(key), 50);
  }
  if(status === 'red'){
    alert('This item is marked RED (error). Check logs or ask for assistance.');
  }
}

function attachWordHandlers(){
  document.querySelectorAll('.word').forEach(w=>{
    w.removeEventListener('click', onWordClick); // safe detach
    w.addEventListener('click', onWordClick);
    w.addEventListener('touchstart', ev=>{ ev.preventDefault(); onWordClick.call(w, ev); }, { passive:false });
  });
}

/* App Builder simple flow for yellow words */
async function startAppBuilder(topic){
  try{
    const ok = confirm(`Start App Builder for "${topic}"?`);
    if(!ok) { appendLog(`App Builder cancelled for ${topic}`); return; }
    // ask quick questions
    const appName = prompt('App name (short):', topic + ' App');
    if(!appName) { appendLog('App Builder aborted (no name)'); return; }
    const purpose = prompt('What is the main purpose of this app?', 'Mapping / navigation / suggestions');
    const users = prompt('Target users (comma separated)', 'me,team');
    // produce a small "scaffold" preview (not publishing anything)
    const preview = { appName, topic, purpose, users: users ? users.split(',').map(s=>s.trim()) : [], created: new Date().toISOString() };
    appendLog(`App Builder created stub: ${appName} for topic ${topic}`);
    alert('App scaffold created in-session. Check Logs view to copy encrypted or commit.');
    // record scaffold into session log
    appendLog('APP_SCAFFOLD: ' + JSON.stringify(preview));
  }catch(e){ appendLog('App Builder error: ' + (e && e.message)); logDebug('App Builder error: ' + (e && e.stack || e)); }
}

/* ---------- Admin: fetch & decrypt ---------- */
$('paste_clip') && $('paste_clip').addEventListener('click', async ()=>{
  try{ const t = await navigator.clipboard.readText(); $('admin_blob').value = t; $('admin_status').textContent = 'Pasted from clipboard'; }catch(e){ $('admin_status').textContent = 'Clipboard read failed'; logDebug('Clipboard read failed: ' + e.message); }
});
$('fetch_blob') && $('fetch_blob').addEventListener('click', async ()=>{
  const url = $('admin_rawurl').value.trim(); if(!url) return alert('Enter raw URL');
  $('admin_status').textContent = 'Fetching...'; try{ const txt = await fetch(url,{cache:'no-store'}).then(r=>{ if(!r.ok) throw new Error(r.status); return r.text(); }); $('admin_blob').value = txt; $('admin_status').textContent = 'Fetched'; appendLog('Fetched blob from raw URL'); }catch(e){ $('admin_status').textContent = 'Fetch failed: ' + e.message; logDebug('Fetch blob error: ' + e.message); }
});

$('admin_unlock').addEventListener('click', async ()=>{
  const pass = $('admin_pass').value;
  let txt = $('admin_blob').value.trim();
  $('admin_status').textContent = 'Unlocking...';
  try{
    if(!txt){
      // no blob provided; try check localStorage embedded
      const saved = localStorage.getItem('pewpi_embedded_ct');
      if(saved){ txt = saved; $('admin_status').textContent = 'Using saved embedded ciphertext'; }
      else throw new Error('No ciphertext found; paste it or fetch raw URL.');
    }
    const blob = JSON.parse(txt);
    const plain = await decryptBlob(blob, pass);
    $('admin_plain').textContent = JSON.stringify(plain, null, 2);
    window._decrypted_plain = plain;
    $('admin_status').textContent = 'Decrypted OK';
    appendLog('Decryption succeeded');
    // auto-load token if present
    if(plain && plain.secrets && plain.secrets.github_token){
      setToken(plain.secrets.github_token);
      $('admin_status').textContent += ' — token auto-loaded';
      showView('portal');
      portalAnnounce('Token loaded from decrypted blob.');
    }
  }catch(e){ $('admin_status').textContent = 'Unlock failed: ' + (e && e.message ? e.message : e); logDebug('Decrypt error: ' + (e && e.stack || e)); appendLog('Decrypt failed'); }
});

$('load_pat') && $('load_pat').addEventListener('click', ()=>{
  const t = $('admin_pat').value.trim();
  if(!t) return alert('Paste PAT first');
  setToken(t);
  $('admin_status').textContent = 'PAT loaded (in-memory)';
  appendLog('PAT loaded in-memory');
});
$('clear_pat') && $('clear_pat').addEventListener('click', ()=>{ clearToken(); });

$('load_token_from_plain') && $('load_token_from_plain').addEventListener('click', ()=>{
  try{
    const txt = $('admin_plain').textContent;
    if(!txt || txt.includes('none')) return alert('Nothing decrypted');
    const obj = JSON.parse(txt);
    if(!obj.secrets || !obj.secrets.github_token) return alert('No github_token present');
    setToken(obj.secrets.github_token);
    $('admin_status').textContent = 'Token loaded from plaintext';
    appendLog('Token loaded from plaintext');
  }catch(e){ $('admin_status').textContent = 'Load failed: ' + (e && e.message); logDebug('Load token from plain failed: ' + e); }
});

/* re-encrypt convenience (change passphrase) */
$('re_encrypt') && $('re_encrypt').addEventListener('click', async ()=>{
  try{
    const plain = window._decrypted_plain;
    if(!plain) return alert('Decrypt first');
    const newPass = prompt('Enter NEW passphrase (do N